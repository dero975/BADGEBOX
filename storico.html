<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Storico Timbrature</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Sfondo generale */
    body {
      background-color: #0c1a2a;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    /* Stili tabella */
    .titolo-piccolo {
      text-align: center;
      color: #a0aec0;
      font-size: 19.6px;
      margin-bottom: 0;
    }
    .titolo-grande {
      text-align: center;
      font-size: 39.2px;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 10px;
      color: white;
    }
    .filtro-temporale {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: nowrap;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
      padding: 0 15px;
    }

    .filtro-temporale select {
      flex: 0 0 210px;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #334155;
      font-family: Arial, sans-serif;
      font-weight: 400;
      height: 48px;
      line-height: 24px;
      box-sizing: border-box;
      background-color: #1e293b;
      color: white;
      width: 210px;
    }
    .data-container {
      position: relative;
      flex: 0 0 210px;
      width: 210px;
    }
    .filtro-temporale input[type="date"] {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #334155;
      font-family: Arial, sans-serif;
      font-weight: 400;
      height: 48px;
      line-height: 24px;
      box-sizing: border-box;
      background-color: #1e293b;
      color: white;
    }

    /* Nasconde l'icona calendario nativa del browser */
    .filtro-temporale input[type="date"]::-webkit-calendar-picker-indicator {
      opacity: 0;
      pointer-events: none;
    }

    .filtro-temporale input[type="date"]::-moz-calendar-picker-indicator {
      opacity: 0;
      pointer-events: none;
    }
    .icona-calendario-campo {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      cursor: pointer;
      z-index: 10;
    }


    .container {
      padding-bottom: 20px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      padding: 20px;
    }
    .tabella-wrapper {
      background-color: #1e293b;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6);
      margin-bottom: 10px;
      padding: 13px;
      overflow: hidden;
      overflow-x: auto;
    }
    .tabella-container {
      background-color: transparent;
      border-radius: 0;
      padding: 0;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background-color: transparent;
      border-radius: 0;
    }
    table th, table td {
      border-bottom: 1px solid #334155;
      border-right: 1px solid #334155;
      padding: 11px 12px;
      text-align: center;
      color: white;
    }
    table th:first-child, table td:first-child {
      width: 20%;
    }
    table th:first-child, table td:first-child {
      border-left: 1px solid #334155;
    }
    table th:last-child, table td:last-child {
      border-right: 1px solid #334155;
    }
    /* Righe dei giorni con altezza ridotta del 20% */
    table tbody tr:not(:last-child) td {
      padding: 6px 12px;
    }
    table th {
      background-color: #1f3a56;
      font-weight: 600;
      font-size: 15px;
    }
    table td {
      background-color: #1e293b;
    }

    /* Stile per sabati e domeniche */
    table tr.weekend td {
      background-color: #19202F;
    }



    table tr:last-child td {
      border-bottom: none;
    }
    /* Colonna icona modifica */
    .modifica-icon {
      cursor: pointer;
      user-select: none;
      display: inline-block;
      line-height: 1;
      width: 20px;
      height: 20px;
    }
    /* Modale overlay */
    #modalOverlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    /* Modale container */
    #modal {
      background: #1e2a38;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      max-width: 90%;
      color: white;
      box-sizing: border-box;
      max-height: 90vh;
      overflow-y: auto;
      font-family: Arial, sans-serif;
    }
    #modal h2 {
      margin-top: 0;
      margin-bottom: 15px;
      text-transform: capitalize;
      font-weight: 700;
      font-size: 20px;
      text-align: center;
    }
    label {
      display: block;
      margin-bottom: 5px;
      margin-top: 15px;
      font-weight: 600;
    }
    input[type="time"], input[type="date"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
      box-sizing: border-box;
      color: #000000;
    }
    .modal-btns {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
    }
    button#btnSalva {
      background-color: #1e90ff;
      color: white;
    }
    button#btnElimina {
      background-color: #dc3545;
      color: white;
    }
    button#btnChiudi {
      background-color: #666;
      color: white;
    }
    /* Contenitore pulsanti in fondo alla tabella */
    .pulsanti-basso {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      gap: 12px;
      margin-top: 8px;
      padding: 4px 0;
    }
    .pulsanti-basso button {
      cursor: pointer;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-weight: 700;
      font-size: 14px;
      color: #222;
      background: #ddd;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.25s;
      min-width: 80px;
      justify-content: center;
      height: 40px;
    }
    /* Modifica altezza tasto torna */
    #torna-archivio {
      height: 40px;
      padding: 10px 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
      font-weight: 700;
      font-size: 14px;
      color: #222;
      background: #ddd;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .pulsanti-basso button:hover {
      background: #1e90ff;
      color: white;
    }
    .pulsanti-basso button img {
      width: 24px;
      height: 24px;
    }

    /* Icona PDF personalizzata */
    .pdf-icon {
      display: inline-block;
      background-color: #dc3545;
      color: white;
      font-size: 10px;
      font-weight: bold;
      padding: 2px 4px;
      border-radius: 3px;
      min-width: 20px;
      text-align: center;
      line-height: 1.2;
      letter-spacing: 0.5px;
    }

    /* Media query per tablet e schermi medi */
    @media (max-width: 1024px) and (min-width: 768px) {
      .filtro-temporale {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        padding: 0 20px;
        max-width: 100%;
        margin-bottom: 20px;
      }

      .filtro-temporale select {
        width: 100%;
        max-width: 400px;
        font-size: 16px;
        padding: 14px 18px;
        height: 52px;
        box-sizing: border-box;
      }

      .data-container {
        width: 100%;
        max-width: 400px;
        position: relative;
        box-sizing: border-box;
      }

      .filtro-temporale input[type="date"] {
        width: 100%;
        font-size: 16px;
        padding: 14px 18px;
        height: 52px;
        box-sizing: border-box;
      }

      .icona-calendario-campo {
        right: 12px;
        width: 22px;
        height: 22px;
      }
    }

    /* Media query per schermi piccoli/mobile */
    @media (max-width: 767px) {
      .filtro-temporale {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
        padding: 0 10px;
        max-width: 100%;
      }

      .filtro-temporale select,
      .data-container {
        flex: none;
        width: 100%;
        max-width: 100%;
        margin: 0;
      }

      .filtro-temporale input[type="date"] {
        width: 100%;
      }

      .container {
        padding: 15px;
      }

      .titolo-grande {
        font-size: 32px;
      }

      .titolo-piccolo {
        font-size: 16px;
      }
    }

    /* Media query per schermi molto piccoli */
    @media (max-width: 480px) {
      .filtro-temporale {
        gap: 12px;
        padding: 0 10px;
        margin-bottom: 20px;
      }

      .filtro-temporale select,
      .filtro-temporale input[type="date"] {
        font-size: 15px;
        padding: 12px 14px;
        height: 48px;
      }

      .container {
        padding: 10px;
      }

      .titolo-grande {
        font-size: 24px;
        margin-bottom: 12px;
      }

      .titolo-piccolo {
        font-size: 14px;
      }

      /* Ottimizzazioni tabella per mobile */
      .tabella-wrapper {
        padding: 8px;
        margin-bottom: 15px;
      }

      table th, table td {
        padding: 6px 4px;
        font-size: 12px;
        line-height: 1.2;
      }

      /* Colonne più strette per mobile */
      table th:first-child, table td:first-child {
        width: 25%;
        font-size: 11px;
      }

      table th:nth-child(2), table td:nth-child(2),
      table th:nth-child(3), table td:nth-child(3) {
        width: 18%;
      }

      table th:nth-child(4), table td:nth-child(4) {
        width: 20%;
      }

      table th:last-child, table td:last-child {
        width: 19%;
      }

      /* Testo ore più piccolo su mobile */
      table td:nth-child(4) {
        font-size: 11px;
        font-weight: bold;
      }

      .pulsanti-basso {
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        padding: 0 10px;
      }

      .pulsanti-basso button {
        flex: 1;
        min-width: 70px;
        padding: 8px 12px;
        font-size: 12px;
        height: 40px;
      }

      .modifica-icon {
        width: 16px;
        height: 16px;
      }

      .icona-calendario-campo {
        width: 18px;
        height: 18px;
        right: 8px;
      }

      /* Modale più adatto a mobile */
      #modal {
        width: 95%;
        padding: 15px;
        max-height: 85vh;
      }

      #modal h2 {
        font-size: 18px;
        margin-bottom: 12px;
      }

      #modal input[type="time"], 
      #modal input[type="date"] {
        font-size: 16px;
        padding: 8px 10px;
      }

      .modal-btns {
        margin-top: 15px;
        gap: 8px;
      }

      .modal-btns button {
        padding: 8px 12px;
        font-size: 13px;
      }
    }

    /* Media query per tablet - layout pulsanti */
    @media (max-width: 1024px) and (min-width: 768px) {
      .pulsanti-basso {
        gap: 10px;
        padding: 0 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container" style="position: relative;">
    <div style="position: relative; text-align: center; margin-bottom: 10px;">
      <img src="assets/icons/logo.png" alt="BadgeBox Logo" style="width: 120px; height: auto; margin-bottom: -5px;" />
      <p class="titolo-piccolo">Storico Timbrature</p>
      <h1 id="intestazione" class="titolo-grande">Nome Cognome</h1>
    </div>
    <div class="filtro-temporale">
      <select id="filtro-mese">
        <option value="corrente">Mese corrente</option>
        <option value="precedente">Mese precedente</option>
        <option value="due-precedenti">2 mesi precedenti</option>

      </select>
      <div class="data-container">
        <input type="date" id="data-inizio" />
        <img src="assets/icons/calendario.png" class="icona-calendario-campo" alt="Calendario" onclick="document.getElementById('data-inizio').showPicker()" />
      </div>
      <div class="data-container">
        <input type="date" id="data-fine" />
        <img src="assets/icons/calendario.png" class="icona-calendario-campo" alt="Calendario" onclick="document.getElementById('data-fine').showPicker()" />
      </div>
    </div>
    <div class="tabella-wrapper">
      <div class="tabella-container">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Entrata</th>
              <th>Uscita</th>
              <th>Ore</th>
              <th>Modifica</th>
            </tr>
          </thead>
          <tbody id="storico-body"></tbody>
        </table>
      </div>
    </div>
    <!-- Pulsanti in fondo tabella -->
    <div class="pulsanti-basso">
      <button id="torna-archivio" title="Torna Archivio">
        <img src="assets/icons/freccia.png" alt="Torna Archivio" />
      </button>
      <button id="btn-invia" title="Scarica PDF">
        <img src="assets/icons/pdf.png" alt="PDF" />
      </button>
      <button id="btn-esporta" title="Esporta Excel">
        <img src="assets/icons/esporta.png" alt="Esporta Excel" />
      </button>
    </div>
  </div>
  <!-- Modale -->
  <div id="modalOverlay">
    <div id="modal">
      <h2>Modifica Timbrature</h2>
      <form id="modaleForm">
        <label>Data:</label>
        <input type="date" id="modale-data" disabled />
        <label for="modale-entrata">Entrata:</label>
        <input type="time" id="modale-entrata" />
        <label for="modale-uscita">Uscita:</label>
        <input type="time" id="modale-uscita" />
        <div class="modal-btns">
          <button type="button" id="btnSalva">Salva</button>
          <button type="button" id="btnElimina">Elimina</button>
          <button type="button" id="btnChiudi">Chiudi</button>
        </div>
      </form>
    </div>
  </div>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(
      "https://pylfpqitdogatlsndxtf.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5bGZwcWl0ZG9nYXRsc25keHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzNzU5OTcsImV4cCI6MjA2Mzk1MTk5N30.GXWmglDP7WcLSozta8UT6Ktd9XzIXSCxC5pJ4oWX3LU"
    );
    const intestazione = document.getElementById("intestazione");
    const tbody = document.getElementById("storico-body");
    const selectFiltro = document.getElementById("filtro-mese");
    const dataInizio = document.getElementById("data-inizio");
    const dataFine = document.getElementById("data-fine");
    // Recupera il PIN dalla query string con gestione errori
    const urlParams = new URLSearchParams(window.location.search);
    let pin = urlParams.get("pin");
    console.log("URL completa:", window.location.href);
    console.log("Query string:", window.location.search);
    console.log("PIN dalla URL:", pin);

    // Debug per Netlify
    if (!pin) {
      console.warn("PIN non trovato nella URL, possibile problema di routing");
      console.log("Location:", window.location);
    }
    let dipendente = null;
    let timbrature = [];
    function aggiornaRange(mese) {
      const oggi = new Date();
      let anno = oggi.getFullYear();
      let meseIndice = oggi.getMonth();

      if (mese === "precedente") {
        meseIndice -= 1;
        if (meseIndice < 0) {
          meseIndice = 11;
          anno -= 1;
        }
      } else if (mese === "due-precedenti") {
        meseIndice -= 2;
        if (meseIndice < 0) {
          meseIndice += 12;
          anno -= 1;
        }
      }

      // Forza il primo giorno del mese alle 12:00 per evitare problemi di timezone
      const primoGiorno = new Date(anno, meseIndice, 1, 12, 0, 0);
      const ultimoGiorno = new Date(anno, meseIndice + 1, 0, 12, 0, 0);
      
      const dataInizioString = primoGiorno.toISOString().split('T')[0];
      const dataFineString = ultimoGiorno.toISOString().split('T')[0];

      dataInizio.value = dataInizioString;
      dataFine.value = dataFineString;

      console.log(`Range aggiornato: dal ${dataInizioString} al ${dataFineString}`);
      console.log(`Mese: ${meseIndice + 1}/${anno}, Primo giorno: ${primoGiorno.getDate()}, Ultimo giorno: ${ultimoGiorno.getDate()}`);
    }
    selectFiltro.addEventListener("change", () => {
      if (selectFiltro.value !== "personalizzato") {
        // Rimuove l'opzione personalizzato se presente
        const opzionePersonalizzato = selectFiltro.querySelector('option[value="personalizzato"]');
        if (opzionePersonalizzato) {
          opzionePersonalizzato.remove();
        }
        aggiornaRange(selectFiltro.value);
      }
      caricaDati();
    });

    // Quando l'utente modifica manualmente le date, passa a "personalizzato"
    function aggiungiOpzionePersonalizzato() {
      let opzionePersonalizzato = selectFiltro.querySelector('option[value="personalizzato"]');
      if (!opzionePersonalizzato) {
        opzionePersonalizzato = document.createElement('option');
        opzionePersonalizzato.value = 'personalizzato';
        opzionePersonalizzato.textContent = 'Personalizzato';
        opzionePersonalizzato.style.color = '#ffffe0';
        opzionePersonalizzato.style.backgroundColor = '#1e293b';
        selectFiltro.appendChild(opzionePersonalizzato);
      }
      selectFiltro.value = "personalizzato";
    }

    dataInizio.addEventListener("change", () => {
      aggiungiOpzionePersonalizzato();
      caricaDati();
    });

    dataFine.addEventListener("change", () => {
      aggiungiOpzionePersonalizzato();
      caricaDati();
    });
    async function caricaDati() {
      if (!pin) return;
      
      try {
        // Recupera dati utente
        const { data: datiUtente, error: errUtente } = await supabase
          .from("utenti")
          .select("nome, cognome, email")
          .or(`pin.eq.${pin},pin.eq.${parseInt(pin)}`)
          .limit(1)
          .single();
          
        if (errUtente) {
          console.error("Errore recupero utente:", errUtente.message);
          alert("Errore recupero utente: " + errUtente.message);
          return;
        }
        
        if (datiUtente) {
          dipendente = datiUtente;
          intestazione.textContent = `${dipendente.nome} ${dipendente.cognome}`;
        }

        // Query unica più robusta che recupera TUTTE le timbrature per il PIN
        const { data, error } = await supabase
          .from("timbrature")
          .select("*")
          .eq("pin", parseInt(pin))
          .order("data", { ascending: true })
          .order("ore", { ascending: true });

        if (error) {
          console.error("Errore nel recupero timbrature:", error);
          alert("Errore nel recupero timbrature: " + error.message);
          return;
        }

        // Filtra le timbrature lato client per maggiore controllo
        timbrature = (data || []).filter(t => {
          // Determina la data di riferimento per il filtro
          let dataRiferimento = t.giornologico || t.data;
          
          // Normalizza la data in formato YYYY-MM-DD
          if (typeof dataRiferimento !== 'string') {
            dataRiferimento = new Date(dataRiferimento).toISOString().split('T')[0];
          } else if (dataRiferimento.includes('T')) {
            dataRiferimento = dataRiferimento.split('T')[0];
          }

          // Confronta le date
          const dentroRange = dataRiferimento >= dataInizio.value && dataRiferimento <= dataFine.value;
          
          if (dentroRange) {
            console.log(`✓ Timbratura inclusa: ID=${t.id}, Tipo=${t.tipo}, Data=${dataRiferimento}, Ore=${t.ore}`);
          }
          
          return dentroRange;
        });

        console.log(`FILTRO APPLICATO: ${timbrature.length} timbrature nel periodo ${dataInizio.value} - ${dataFine.value}`);
        
      } catch (error) {
        console.error("Errore caricamento dati:", error);
        alert("Errore durante il caricamento dei dati");
      }
      
      renderizzaTabella();
    }
    function renderizzaTabella() {
      tbody.innerHTML = "";

      if (!dataInizio.value || !dataFine.value) {
        console.log("Date non impostate correttamente");
        return;
      }

      const start = new Date(dataInizio.value + 'T00:00:00');
      const end = new Date(dataFine.value + 'T00:00:00');
      const giorniSettimana = ["Domenica", "Lunedi", "Martedi", "Mercoledi", "Giovedi", "Venerdi", "Sabato"];
      let totaleMensileOre = 0;

      console.log(`Rendering tabella dal ${start.toISOString().split('T')[0]} al ${end.toISOString().split('T')[0]}`);

      // Corregge il problema del timezone per il rendering tabella
      const startDateFixed = new Date(start.getFullYear(), start.getMonth(), start.getDate(), 12, 0, 0);
      const endDateFixed = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 12, 0, 0);
      
      for (let d = new Date(startDateFixed); d <= endDateFixed; d.setDate(d.getDate() + 1)) {
        const current = new Date(d);
        const dataISO = current.toISOString().split("T")[0];
        const giornoSettimana = giorniSettimana[current.getDay()];
        const giornoNumero = current.getDate().toString().padStart(2, "0");
        // Versione più compatta per mobile
        const isMobile = window.innerWidth <= 480;
        const dataFormattata = isMobile ? 
          `${giornoNumero} ${giornoSettimana.slice(0,3)}` : 
          `${giornoNumero}  ${giornoSettimana}`;

        // Raggruppa timbrature per giorno con logica corretta
        const timbratureOggi = timbrature.filter(t => {
          // Usa giornologico se presente, altrimenti data
          let dataRiferimento = t.giornologico || t.data;
          
          // Normalizza la data in formato YYYY-MM-DD
          if (typeof dataRiferimento !== 'string') {
            dataRiferimento = new Date(dataRiferimento).toISOString().split('T')[0];
          } else if (dataRiferimento.includes('T')) {
            dataRiferimento = dataRiferimento.split('T')[0];
          }
          
          const match = dataRiferimento === dataISO;
          if (match) {
            console.log(`✓ Timbratura per ${dataISO}: ID=${t.id}, Tipo=${t.tipo}, Ore=${t.ore}`);
          }
          
          return match;
        });

        // Separa timbrature per tipo e ordina per ora
        const timbratureEntrata = timbratureOggi.filter(t => t.tipo === "entrata").sort((a, b) => a.ore.localeCompare(b.ore));
        const timbratureUscita = timbratureOggi.filter(t => t.tipo === "uscita").sort((a, b) => a.ore.localeCompare(b.ore));

        // Algoritmo di abbinamento intelligente entrata-uscita
        const coppieTimbrature = [];
        const entrateUsate = new Set();
        const usciteUsate = new Set();

        // Prima passa: abbina le uscite notturne (00:00-06:00) con le entrate della sera precedente
        timbratureUscita.forEach((uscita, uIndex) => {
          const oraUscita = uscita.ore.split(':').map(Number);
          const oreUscita = oraUscita[0] + oraUscita[1] / 60;
          
          // Se è un'uscita notturna (tra 00:00 e 06:00)
          if (oreUscita >= 0 && oreUscita < 6) {
            // Cerca l'entrata della sera precedente non ancora abbinata
            for (let eIndex = timbratureEntrata.length - 1; eIndex >= 0; eIndex--) {
              const entrata = timbratureEntrata[eIndex];
              const oraEntrata = entrata.ore.split(':').map(Number);
              const oreEntrata = oraEntrata[0] + oraEntrata[1] / 60;
              
              // Entrata pomeridiana/serale non ancora abbinata
              if (oreEntrata >= 12 && !entrateUsate.has(eIndex)) {
                coppieTimbrature.push({ entrata, uscita, entrataIndex: eIndex, uscitaIndex: uIndex });
                entrateUsate.add(eIndex);
                usciteUsate.add(uIndex);
                break;
              }
            }
          }
        });

        // Seconda passa: abbina le rimanenti entrate e uscite in ordine cronologico
        timbratureEntrata.forEach((entrata, eIndex) => {
          if (!entrateUsate.has(eIndex)) {
            // Cerca la prima uscita non abbinata
            for (let uIndex = 0; uIndex < timbratureUscita.length; uIndex++) {
              if (!usciteUsate.has(uIndex)) {
                const uscita = timbratureUscita[uIndex];
                coppieTimbrature.push({ entrata, uscita, entrataIndex: eIndex, uscitaIndex: uIndex });
                entrateUsate.add(eIndex);
                usciteUsate.add(uIndex);
                break;
              }
            }
          }
        });

        // Aggiungi timbrature rimaste senza coppia
        timbratureEntrata.forEach((entrata, eIndex) => {
          if (!entrateUsate.has(eIndex)) {
            coppieTimbrature.push({ entrata, uscita: null, entrataIndex: eIndex, uscitaIndex: null });
          }
        });

        timbratureUscita.forEach((uscita, uIndex) => {
          if (!usciteUsate.has(uIndex)) {
            coppieTimbrature.push({ entrata: null, uscita, entrataIndex: null, uscitaIndex: uIndex });
          }
        });

        let oreTotaliGiorno = 0;
        const maxTimbrature = Math.max(coppieTimbrature.length, 1);
        
        for (let i = 0; i < maxTimbrature; i++) {
          const riga = document.createElement("tr");
          if (current.getDay() === 0 || current.getDay() === 6) {
            riga.classList.add('weekend');
          }

          const coppia = coppieTimbrature[i] || {};
          const timbraturaEntrata = coppia.entrata || null;
          const timbraturaUscita = coppia.uscita || null;

          const entrataDisplay = timbraturaEntrata ? timbraturaEntrata.ore.slice(0,5) : '—';
          const uscitaDisplay = timbraturaUscita ? timbraturaUscita.ore.slice(0,5) : '—';

          // Calcola ore lavorate per questa coppia
          let oreLavorateDisplay = '—';
          
          if (timbraturaEntrata && timbraturaUscita) {
            const oraEntrata = timbraturaEntrata.ore;
            const oraUscita = timbraturaUscita.ore;
            if (oraEntrata && oraUscita) {
              const inizio = new Date(`1970-01-01T${oraEntrata}`);
              const fine = new Date(`1970-01-01T${oraUscita}`);
              if (fine < inizio) fine.setDate(fine.getDate() + 1);
              const diffMs = fine - inizio;
              if (diffMs > 0) {
                const h = Math.floor(diffMs / (1000 * 60 * 60));
                const m = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                oreLavorateDisplay = `${h}:${m.toString().padStart(2, '0')}`;
                oreTotaliGiorno += h + m / 60;
              }
            }
          }

          // Determina quale ID usare per la modifica
          const timbraturaId = timbraturaEntrata ? timbraturaEntrata.id : (timbraturaUscita ? timbraturaUscita.id : 'nuovo');

          // Mostra il nome del giorno solo nella prima riga
          const dataDisplay = i === 0 ? dataFormattata : '';

          riga.innerHTML = `
            <td style="text-align: left;">${dataDisplay}</td>
            <td>${entrataDisplay}</td>
            <td>${uscitaDisplay}</td>
            <td style="color: #ffff99;">${oreLavorateDisplay}</td>
            <td>
              <img
                src="assets/icons/matita-colorata.png"
                class="modifica-icon"
                data-data="${dataISO}"
                data-timbratura-id="${timbraturaId}"
                data-entrata-id="${timbraturaEntrata ? timbraturaEntrata.id : ''}"
                data-uscita-id="${timbraturaUscita ? timbraturaUscita.id : ''}"
                title="Modifica"
                alt="Modifica"
              />
            </td>
          `;
          tbody.appendChild(riga);
        }

        totaleMensileOre += oreTotaliGiorno;
      }
      const rigaTotale = document.createElement("tr");
      rigaTotale.style.fontWeight = "bold";
      rigaTotale.style.backgroundColor = "#1f3a56 !important";
      rigaTotale.style.color = "white";
      rigaTotale.innerHTML = `
        <td style="text-align:left; background-color: #1f3a56 !important;">TOTALE MENSILE</td>
        <td style="background-color: #1f3a56 !important;"></td>
        <td style="background-color: #1f3a56 !important;"></td>
        <td style="color: #ffff99; background-color: #1f3a56 !important;">${totaleMensileOre.toFixed(2)}</td>
        <td style="background-color: #1f3a56 !important;"></td>
      `;
      tbody.appendChild(rigaTotale);

      // Aggiungi event listeners per modifica timbrature
      aggiungiListenerModifica();
    }
    function aggiungiListenerModifica() {
      // Usa event delegation per gestire i click sulle icone di modifica
      document.removeEventListener("click", gestisciClickModifica);
      document.addEventListener("click", gestisciClickModifica);
    }

    function gestisciClickModifica(event) {
      if (event.target.classList.contains("modifica-icon")) {
        event.preventDefault();
        event.stopPropagation();

        const icon = event.target;
        const dataSelezionata = icon.dataset.data;
        const timbraturaId = icon.dataset.timbraturaId;

        console.log("Clic su modifica:", dataSelezionata, "timbraturaId:", timbraturaId);
        apriModale(dataSelezionata, timbraturaId);
      }
    }
    const modalOverlay = document.getElementById("modalOverlay");
    let dataCorrenteModale = null;
    let timbraturaCorrente = null;

    // Funzione per convertire da YYYY-MM-DD a DD/MM/YYYY
    function formatDataIT(dataISO) {
      if (!dataISO) return '';
      const [anno, mese, giorno] = dataISO.split('-');
      return `${giorno}/${mese}/${anno}`;
    }
    async function apriModale(dataSelezionata, timbraturaId) {
      dataCorrenteModale = dataSelezionata;

      // Verifica e corregge il formato della data se necessario
      let dataISO = dataSelezionata;
      if (dataSelezionata && dataSelezionata.includes('/')) {
        // Se la data è in formato DD/MM/YYYY, convertila in YYYY-MM-DD
        const parti = dataSelezionata.split('/');
        if (parti.length === 3) {
          dataISO = `${parti[2]}-${parti[1].padStart(2, '0')}-${parti[0].padStart(2, '0')}`;
        }
      }
      dataCorrenteModale = dataISO;

      console.log("Apertura modale per data:", dataISO, "timbraturaId:", timbraturaId);

      // Cerca l'elemento cliccato per ottenere gli ID entrata/uscita
      const iconaCliccata = document.querySelector(`[data-timbratura-id="${timbraturaId}"]`);
      const entrataId = iconaCliccata ? iconaCliccata.dataset.entrataId : '';
      const uscitaId = iconaCliccata ? iconaCliccata.dataset.uscitaId : '';

      // Trova le timbrature corrispondenti
      const timbraturaEntrata = entrataId ? timbrature.find(t => t.id == entrataId) : null;
      const timbraturaUscita = uscitaId ? timbrature.find(t => t.id == uscitaId) : null;

      console.log("Timbrature trovate - Entrata:", timbraturaEntrata, "Uscita:", timbraturaUscita);

      // Modale con entrata e uscita - assicura formato data corretto
      const dataFormattataISO = dataISO; // usa la data corretta in formato ISO
      const modal = document.getElementById("modal");
      modal.innerHTML = `
        <h2>Modifica Timbratura</h2>
        <form id="modaleForm">
          <label>Data:</label>
          <input type="date" id="modale-data" value="${dataFormattataISO}" disabled />
          <label for="modale-entrata">Entrata:</label>
          <input type="time" id="modale-entrata" value="${timbraturaEntrata ? timbraturaEntrata.ore.slice(0,5) : ''}" />
          <label for="modale-uscita">Uscita:</label>
          <input type="time" id="modale-uscita" value="${timbraturaUscita ? timbraturaUscita.ore.slice(0,5) : ''}" />
          <div class="modal-btns">
            <button type="button" id="btnSalva">Salva</button>
            <button type="button" id="btnElimina" ${!timbraturaEntrata && !timbraturaUscita ? 'style="display:none;"' : ''}>Elimina</button>
            <button type="button" id="btnChiudi">Chiudi</button>
          </div>
        </form>
      `;

      // Memorizza le timbrature correnti per il salvataggio
      window.timbraturaEntrataCorrente = timbraturaEntrata;
      window.timbraturaUscitaCorrente = timbraturaUscita;

      // Event listeners
      document.getElementById("btnSalva").addEventListener("click", salvaModificheCoppia);
      if (timbraturaEntrata || timbraturaUscita) {
        document.getElementById("btnElimina").addEventListener("click", eliminaCoppiaTimbrature);
      }
      document.getElementById("btnChiudi").addEventListener("click", chiudiModale);

      modalOverlay.style.display = "flex";
    }
    function chiudiModale() {
      modalOverlay.style.display = "none";
    }

    async function salvaModificheCoppia() {
      const entrataInput = document.getElementById("modale-entrata");
      const uscitaInput = document.getElementById("modale-uscita");

      const oraEntrata = entrataInput.value;
      const oraUscita = uscitaInput.value;
      const pinVal = pin;
      const nomeVal = dipendente ? dipendente.nome : "";
      const cognomeVal = dipendente ? dipendente.cognome : "";

      if (!dataCorrenteModale) {
        alert("Data non valida");
        return;
      }

      // Conferma salvataggio
      if (!confirm("CONFERMI MODIFICHE?")) {
        return;
      }

      try {
        // Salva entrata se presente
        if (oraEntrata) {
          let dataEntrataUsare = dataCorrenteModale;
          const [hEntrata] = oraEntrata.split(":").map(Number);
          
          if (hEntrata >= 0 && hEntrata <= 4) {
            let d = new Date(dataCorrenteModale);
            d.setDate(d.getDate() + 1);
            dataEntrataUsare = d.toISOString().split("T")[0];
          }

          if (window.timbraturaEntrataCorrente && window.timbraturaEntrataCorrente.id) {
            // Aggiorna entrata esistente
            await supabase
              .from("timbrature")
              .update({
                ore: oraEntrata,
                data: dataEntrataUsare,
                giornologico: dataCorrenteModale
              })
              .eq("id", window.timbraturaEntrataCorrente.id);
          } else {
            // Inserisci nuova entrata
            await supabase
              .from("timbrature")
              .insert([{
                tipo: 'entrata',
                pin: pinVal,
                nome: nomeVal,
                cognome: cognomeVal,
                data: dataEntrataUsare,
                ore: oraEntrata,
                giornologico: dataCorrenteModale
              }]);
          }
        } else if (window.timbraturaEntrataCorrente && window.timbraturaEntrataCorrente.id) {
          // Elimina entrata se campo vuoto
          await supabase
            .from("timbrature")
            .delete()
            .eq("id", window.timbraturaEntrataCorrente.id);
        }

        // Salva uscita se presente
        if (oraUscita) {
          let dataUscitaUsare = dataCorrenteModale;
          const [hUscita] = oraUscita.split(":").map(Number);
          
          if (hUscita >= 0 && hUscita <= 4) {
            let d = new Date(dataCorrenteModale);
            d.setDate(d.getDate() + 1);
            dataUscitaUsare = d.toISOString().split("T")[0];
          }

          if (window.timbraturaUscitaCorrente && window.timbraturaUscitaCorrente.id) {
            // Aggiorna uscita esistente
            await supabase
              .from("timbrature")
              .update({
                ore: oraUscita,
                data: dataUscitaUsare,
                giornologico: dataCorrenteModale
              })
              .eq("id", window.timbraturaUscitaCorrente.id);
          } else {
            // Inserisci nuova uscita
            await supabase
              .from("timbrature")
              .insert([{
                tipo: 'uscita',
                pin: pinVal,
                nome: nomeVal,
                cognome: cognomeVal,
                data: dataUscitaUsare,
                ore: oraUscita,
                giornologico: dataCorrenteModale
              }]);
          }
        } else if (window.timbraturaUscitaCorrente && window.timbraturaUscitaCorrente.id) {
          // Elimina uscita se campo vuoto
          await supabase
            .from("timbrature")
            .delete()
            .eq("id", window.timbraturaUscitaCorrente.id);
        }

        await caricaDati();
        chiudiModale();
      } catch (error) {
        console.error("Errore salvataggio:", error);
        alert("Errore salvataggio: " + error.message);
      }
    }

    async function eliminaCoppiaTimbrature() {
      if (!confirm("CONFERMI ELIMINAZIONE DI ENTRAMBE LE TIMBRATURE?")) return;

      try {
        if (window.timbraturaEntrataCorrente && window.timbraturaEntrataCorrente.id) {
          await supabase
            .from("timbrature")
            .delete()
            .eq("id", window.timbraturaEntrataCorrente.id);
        }
        
        if (window.timbraturaUscitaCorrente && window.timbraturaUscitaCorrente.id) {
          await supabase
            .from("timbrature")
            .delete()
            .eq("id", window.timbraturaUscitaCorrente.id);
        }

        await caricaDati();
        chiudiModale();
      } catch (error) {
        console.error("Errore eliminazione:", error);
        alert("Errore eliminazione: " + error.message);
      }
    }

    // Event listeners ora gestiti dinamicamente nella funzione ricostruisciModale
    document.getElementById("torna-archivio").addEventListener("click", () => {
      window.location.href = "utenti.html";
    });

    // Funzione per scaricare PDF
    document.getElementById("btn-invia").addEventListener("click", () => {
      scaricaPDF();
    });

    async function scaricaPDF() {
      try {
        const btnInvia = document.getElementById("btn-invia");
        const originalText = btnInvia.innerHTML;
        btnInvia.innerHTML = '<span style="color: orange;">⏳ Generando...</span>';
        btnInvia.disabled = true;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header del documento
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('STORICO TIMBRATURE', 105, 20, { align: 'center' });

        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(`Dipendente: ${dipendente.nome} ${dipendente.cognome}`, 20, 35);
        doc.text(`Periodo: ${formatDataIT(dataInizio.value)} - ${formatDataIT(dataFine.value)}`, 20, 45);
        doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, 20, 55);

        // Intestazioni tabella
        doc.setFont(undefined, 'bold');
        doc.text('Data', 20, 70);
        doc.text('Entrata', 60, 70);
        doc.text('Uscita', 90, 70);
        doc.text('Ore Lavorate', 120, 70);
        doc.line(20, 72, 180, 72);

        let yPosition = 80;
        let totaleOre = 0;

        // Genera PDF con i dati filtrati
        const timbraturaPerGiorno = {};
        const timbraturaFiltrate = timbrature.filter(t => {
          const dataTimbratura = new Date(t.giornologico);
          const dataInizioObj = new Date(dataInizio.value);
          const dataFineObj = new Date(dataFine.value);
          return dataTimbratura >= dataInizioObj && dataTimbratura <= dataFineObj;
        });

        timbraturaFiltrate.forEach(t => {
          const dataKey = typeof t.giornologico === 'string' ? t.giornologico : new Date(t.giornologico).toISOString().split('T')[0];
          if (!timbraturaPerGiorno[dataKey]) {
            timbraturaPerGiorno[dataKey] = {};
          }
          timbraturaPerGiorno[dataKey][t.tipo] = t;
        });

        Object.keys(timbraturaPerGiorno).sort().forEach(data => {
          const timbraturaEntrata = timbraturaPerGiorno[data].entrata;
          const timbraturaUscita = timbraturaPerGiorno[data].uscita;

          const dataFormattata = formatDataIT(data);
          let oreLavorate = '—';

          if (timbraturaEntrata && timbraturaUscita && timbraturaEntrata.ore && timbraturaUscita.ore) {
            const entrata = new Date(`1970-01-01T${timbraturaEntrata.ore}`);
            const uscita = new Date(`1970-01-01T${timbraturaUscita.ore}`);
            if (uscita < entrata) uscita.setDate(uscita.getDate() + 1);

            const diffMs = uscita - entrata;
            if (diffMs > 0) {
              const h = Math.floor(diffMs / (1000 * 60 * 60));
              const m = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
              oreLavorate = `${h}:${m.toString().padStart(2, '0')}`;
              totaleOre += h + m / 60;
            }
          }

          doc.setFont(undefined, 'normal');
          const oraEntrataDisplay = timbraturaEntrata && timbraturaEntrata.ore ? timbraturaEntrata.ore.slice(0,5) : '—';
          const oraUscitaDisplay = timbraturaUscita && timbraturaUscita.ore ? timbraturaUscita.ore.slice(0,5) : '—';

          doc.text(dataFormattata, 20, yPosition);
          doc.text(oraEntrataDisplay, 60, yPosition);
          doc.text(oraUscitaDisplay, 90, yPosition);
          doc.text(oreLavorate, 120, yPosition);

          yPosition += 8;
        });

        // Totale
        yPosition += 5;
        doc.line(20, yPosition, 180, yPosition);
        yPosition += 10;
        doc.setFont(undefined, 'bold');
        doc.text('TOTALE MENSILE:', 20, yPosition);
        doc.text(`${totaleOre.toFixed(2)} ore`, 120, yPosition);

        // Scarica il PDF
        const filename = `StoricoTimbrature_${dipendente.nome}_${dipendente.cognome}_${dataInizio.value}_to_${dataFine.value}.pdf`;
        doc.save(filename);

        // Feedback successo
        btnInvia.innerHTML = '<span style="color: green;">✓ Scaricato!</span>';
        setTimeout(() => {
          btnInvia.innerHTML = originalText;
          btnInvia.disabled = false;
        }, 3000);

      } catch (error) {
        console.error('Errore generazione PDF:', error);
        alert('Errore durante la generazione del PDF.');

        const btnInvia = document.getElementById("btn-invia");
        btnInvia.innerHTML = '<img src="assets/icons/pdf.png" alt="PDF" />';
        btnInvia.disabled = false;
      }
    }

    

    document.getElementById("btn-esporta").addEventListener("click", () => {
      esportaExcel();
    });

    // Funzione esporta Excel aggiornata con formattazione e totali
    function esportaExcel() {
      if (!dipendente) {
        alert("Utente non definito");
        return;
      }
      // Funzione per convertire da YYYY-MM-DD a DD/MM/YYYY
      function formatDataIT(dataISO) {
        const [anno, mese, giorno] = dataISO.split("-");
        return `${giorno}/${mese}/${anno}`;
      }
      // Crea un nuovo workbook e worksheet
      const wb = XLSX.utils.book_new();
      // Prepara i dati da esportare in tabella
      const dataPerExport = [];
      // Intestazioni personalizzate nome e periodo (righe 1 e 2)
      dataPerExport.push([`Nome: ${dipendente.nome} ${dipendente.cognome}`]);
      dataPerExport.push([`Periodo: ${formatDataIT(dataInizio.value)} - ${formatDataIT(dataFine.value)}`]);
      dataPerExport.push([]); // riga vuota
      // Riga intestazione colonna (riga 4)
      dataPerExport.push(["Data", "Entrata", "Uscita", "Ore"]);
      // Riempi righe dati e calcolo totale ore
      let totaleOre = 0;
      const giorniSettimana = ["Domenica", "Lunedi", "Martedi", "Mercoledi", "Giovedi", "Venerdi", "Sabato"];
      // Ciclo per data nel range corretto (con timezone fix)
      const startDate = new Date(dataInizio.value + 'T12:00:00');
      const endDate = new Date(dataFine.value + 'T12:00:00');
      
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const current = new Date(d);
        const dataISO = current.toISOString().split("T")[0];
        const giornoSettimana = giorniSettimana[current.getDay()];
        const giornoNumero = current.getDate().toString().padStart(2, "0");
        const dataFormattata = `${giornoNumero} ${giornoSettimana}`;
        const timbratureOggi = timbrature.filter(t => {
          if (!t.giornologico && !t.data) return false;
          
          // Usa giornologico se presente, altrimenti usa data
          let gLogico = t.giornologico || t.data;
          
          if (typeof gLogico !== "string") {
            gLogico = new Date(gLogico).toISOString().split("T")[0];
          }
          
          // Se giornologico non è presente, usa la data della timbratura
          if (!t.giornologico) {
            gLogico = new Date(t.data).toISOString().split("T")[0];
          }
          
          console.log(`Confronto: ${gLogico} === ${dataISO} per PIN ${t.pin}`);
          return gLogico === dataISO;
        });
        const timbraturaEntrata = timbratureOggi.find(t => t.tipo === "entrata") || null;
        const timbraturaUscita = timbratureOggi.find(t => t.tipo === "uscita") || null;
        let oreLavorate = "—";
        if (timbraturaEntrata && timbraturaUscita) {
          const oraEntrata = timbraturaEntrata.ore;
          const oraUscita = timbraturaUscita.ore;
          if (oraEntrata && oraUscita) {
            const inizio = new Date(`1970-01-01T${oraEntrata}`);
            const fine = new Date(`1970-01-01T${oraUscita}`);
            if (fine < inizio) fine.setDate(fine.getDate() + 1);
            const diffMs = fine - inizio;
            const h = Math.floor(diffMs / (1000 * 60 * 60));
            const m = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            oreLavorate = `${h}:${m.toString().padStart(2, '0')}`;
            totaleOre += h + m / 60;
          }
        }
        dataPerExport.push([dataFormattata, timbraturaEntrata && timbraturaEntrata.ore ? timbraturaEntrata.ore.slice(0,5) : "—", timbraturaUscita && timbraturaUscita.ore ? timbraturaUscita.ore.slice(0,5) : "—", oreLavorate]);
      }
      // Riga totale ore (ultima)
      dataPerExport.push(["TOTALE MENSILE", "", "", totaleOre.toFixed(2)]);
      // Crea worksheet dal data array
      const ws = XLSX.utils.aoa_to_sheet(dataPerExport);
      // Imposta larghezza colonne per migliore visibilità
      ws["!cols"] = [
        {wpx: 120},
        {wpx: 80},
        {wpx: 80},
        {wpx: 80}
      ];
      // Aggiungi foglio al workbook
      XLSX.utils.book_append_sheet(wb, ws, "Storico Timbrature");
      // Esporta file con nome dinamico
      const nomeFile = `StoricoTimbrature_${dipendente.nome}_${dipendente.cognome}_${dataInizio.value}_to_${dataFine.value}.xlsx`;
      XLSX.writeFile(wb, nomeFile);
    }
    window.addEventListener("load", () => {
      // Imposta il range per il mese corrente usando la funzione aggiornaRange
      aggiornaRange("corrente");
      
      console.log(`Mese corrente impostato: ${dataInizio.value} - ${dataFine.value}`);
      
      caricaDati();
    });
  </script>
</body>
</html>